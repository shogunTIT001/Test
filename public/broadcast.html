<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Host - Select Mode</title>
    <style>
        body { font-family: sans-serif; text-align: center; margin-top: 30px; background: #f0f0f0; }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
        .control-panel {
            background: white; padding: 20px; border-radius: 10px;
            display: inline-block; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            max-width: 400px;
        }
        button { 
            padding: 12px 25px; font-size: 18px; cursor: pointer; 
            background: #007bff; color: white; border: none; border-radius: 5px; margin-top: 15px; width: 100%;
        }
        button:hover { background: #0056b3; }
        
        .mode-select { text-align: left; margin: 15px 0; }
        .mode-select label { display: block; margin-bottom: 10px; cursor: pointer; font-size: 16px;}
        .mode-select input { margin-right: 10px; transform: scale(1.2); }

        video, canvas { display: none; }
        .status { margin-top: 15px; color: #555; font-size: 14px;}
        .note { color: #d32f2f; font-size: 13px; margin-top: 10px; text-align: left;}
    </style>
</head>
<body>

    <div class="control-panel">
        <h1>üéß Broadcast Studio</h1>
        
        <div class="mode-select">
            <label>
                <input type="radio" name="mode" value="av" checked> 
                üì∫ <b>Video + Audio</b> (‡πÅ‡∏ä‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á)
            </label>
            <label>
                <input type="radio" name="mode" value="audio"> 
                üéµ <b>Audio Only</b> (‡πÅ‡∏ä‡∏£‡πå‡πÅ‡∏Ñ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÄ‡∏ô‡πá‡∏ï)
            </label>
        </div>

        <div class="note">
            * ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡πä‡∏Å <b>"Share system audio"</b> ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÄ‡∏™‡∏°‡∏≠
        </div>

        <button id="startBtn">üî¥ Start Broadcasting</button>
        <div class="status" id="status">Status: Standby</div>
    </div>

    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
        const FPS = 10;
        const SCALE = 0.5;
        const QUALITY = 0.5;
        const AUDIO_BUFFER = 16384//4096;// ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ö‡∏±‡∏ü‡πÄ‡∏ü‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏´‡∏ç‡πà = ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏î‡∏µ ‡πÅ‡∏ï‡πà‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏ô‡πá‡∏ï‡∏°‡∏≤‡∏Å)

        // ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏ï‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Audio Only (‡πÄ‡∏õ‡πá‡∏ô Base64 ‡∏™‡∏µ‡∏î‡∏≥‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ Audio Only)
        // ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏≠‡∏≤‡∏£‡∏π‡∏õ‡∏≠‡∏∑‡πà‡∏ô‡∏°‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Base64 ‡πÉ‡∏™‡πà‡πÅ‡∏ó‡∏ô‡πÑ‡∏î‡πâ
        const AUDIO_PLACEHOLDER = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MDAiIGhlaWdodD0iMzAwIiB2aWV3Qm94PSIwIDAgNDAwIDMwMCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iIzIyMiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIzMCIgZmlsbD0iIzRmYWNmZSI+8J+NjSBBdWRpbyBPbmx5PC90ZXh0Pjwvc3ZnPg==";

        startBtn.addEventListener('click', async () => {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            
            try {
                // 1. ‡∏Ç‡∏≠‡πÅ‡∏ä‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡πÅ‡∏°‡πâ‡∏à‡∏∞‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏á)
                const stream = await navigator.mediaDevices.getDisplayMedia({ 
                    video: { cursor: "always" }, 
                    audio: {
                        echoCancellation: false, 
                        noiseSuppression: false,
                        autoGainControl: false
                    } 
                });

                video.srcObject = stream;
                status.innerText = `Status: Broadcasting (${mode === 'av' ? 'Video+Audio' : 'Audio Only'})...`;
                status.style.color = "green";
                startBtn.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°

                // ============================
                // üì° ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏û (VIDEO)
                // ============================
                if (mode === 'av') {
                    // ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥: ‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡∏ï‡∏≤‡∏°‡∏£‡∏≠‡∏ö FPS
                    setInterval(() => {
                        if (video.readyState === video.HAVE_ENOUGH_DATA) {
                            canvas.width = video.videoWidth * SCALE;
                            canvas.height = video.videoHeight * SCALE;
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                            const imageData = canvas.toDataURL("image/jpeg", QUALITY);
                            socket.emit("stream_data", imageData);
                        }
                    }, 1000 / FPS);
                } else {
                    // ‡πÇ‡∏´‡∏°‡∏î Audio Only: ‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡∏ô‡∏¥‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏û‡∏≠ ‡∏à‡∏ö!
                    socket.emit("stream_data", AUDIO_PLACEHOLDER);
                    
                    // (Optional) ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
                    setInterval(() => {
                        socket.emit("stream_data", AUDIO_PLACEHOLDER);
                    }, 5000);
                }

                // ============================
                // üîä ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏á (AUDIO)
                // ============================
                if (stream.getAudioTracks().length > 0) {
                    const audioCtx = new AudioContext();
                    const source = audioCtx.createMediaStreamSource(stream);

                    // ‡πÉ‡∏ä‡πâ AUDIO_BUFFER ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô 16384
                    const processor = audioCtx.createScriptProcessor(AUDIO_BUFFER, 1, 1);

                    source.connect(processor);
                    processor.connect(audioCtx.destination);

                    processor.onaudioprocess = (e) => {
                        const inputData = e.inputBuffer.getChannelData(0); 
                        
                        // --- üîß ‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡∏•‡∏î‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÄ‡∏ô‡πá‡∏ï (Downsampling) ---
                        // ‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏∞‡∏°‡∏≤ 44100 ‡∏´‡∏£‡∏∑‡∏≠ 48000 Hz ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏¢‡∏≠‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡∏£‡∏µ‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÜ
                        // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà "‡∏ó‡∏∏‡∏Å‡πÜ 2 ‡∏Ñ‡πà‡∏≤" (Downsample Factor = 2) 
                        // ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á ‡πÅ‡∏ï‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏¢‡∏±‡∏á‡∏ü‡∏±‡∏á‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏µ‡∏≠‡∏¢‡∏π‡πà
                        
                        const step = 2; // ‡πÄ‡∏Å‡πá‡∏ö 1 ‡∏Ç‡πâ‡∏≤‡∏° 1 (‡∏ñ‡πâ‡∏≤‡πÄ‡∏ô‡πá‡∏ï‡∏ä‡πâ‡∏≤‡∏°‡∏≤‡∏Å ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 4 ‡πÑ‡∏î‡πâ)
                        const pcmData = new Int16Array(Math.floor(inputData.length / step));
                        
                        let index = 0;
                        for (let i = 0; i < inputData.length; i += step) {
                            let s = Math.max(-1, Math.min(1, inputData[i]));
                            pcmData[index] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                            index++;
                        }
                        
                        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ
                        socket.emit("stream_audio", pcmData.buffer);
                    };
                } else {
                    status.innerText += " (‚ö†Ô∏è Warning: No Audio Detected)";
                    alert("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î Stop ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ‡πÇ‡∏î‡∏¢‡∏ï‡∏¥‡πä‡∏Å 'Share system audio'");
                }

            } catch (err) {
                console.error(err);
                status.innerText = "Error: " + err.message;
            }
        });
    </script>
</body>
</html>