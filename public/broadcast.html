<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Host - Share Screen & Audio</title>
    <style>
        body { font-family: sans-serif; text-align: center; margin-top: 50px; background: #f0f0f0; }
        button { padding: 15px 30px; font-size: 20px; cursor: pointer; background: #d32f2f; color: white; border: none; border-radius: 5px; }
        button:hover { background: #b71c1c; }
        video, canvas { display: none; }
        .status { margin-top: 20px; color: #555; }
        .note { color: #f57c00; font-weight: bold; margin-top: 10px;}
    </style>
</head>
<body>

    <h1>üíª Host Page (Video + Audio)</h1>
    <p>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ä‡∏£‡πå (‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ï‡∏¥‡πä‡∏Å <b>"Share system audio"</b> ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤)</p>
    <button id="startBtn">üî¥ Start Sharing</button>
    <div class="status" id="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</div>
    <div class="note">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏Å‡πá‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ä‡∏£‡πå "Entire Screen" ‡∏´‡∏£‡∏∑‡∏≠ "Tab" (Window ‡∏ö‡∏≤‡∏á‡∏≠‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á)</div>

    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Video
        const FPS = 10; 
        const SCALE = 0.5;
        const QUALITY = 0.5;

        startBtn.addEventListener('click', async () => {
            try {
                // 1. ‡∏Ç‡∏≠‡πÅ‡∏ä‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                const stream = await navigator.mediaDevices.getDisplayMedia({ 
                    video: { cursor: "always" }, 
                    audio: {
                        echoCancellation: false, // ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏ä‡∏±‡∏î‡πÜ
                        noiseSuppression: false,
                        autoGainControl: false
                    } 
                });

                video.srcObject = stream;
                status.innerText = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏ä‡∏£‡πå...";
                startBtn.style.display = 'none';

                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ VIDEO ---
                setInterval(() => {
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        canvas.width = video.videoWidth * SCALE;
                        canvas.height = video.videoHeight * SCALE;
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        const imageData = canvas.toDataURL("image/jpeg", QUALITY);
                        socket.emit("stream_data", imageData);
                    }
                }, 1000 / FPS);

                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ AUDIO ---
                if (stream.getAudioTracks().length > 0) {
                    const audioCtx = new AudioContext();
                    const source = audioCtx.createMediaStreamSource(stream);
                    
                    // ‡πÉ‡∏ä‡πâ ScriptProcessor ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏¥‡∏ö (PCM)
                    // bufferSize 4096 = ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡πÜ ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 0.09 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                    const processor = audioCtx.createScriptProcessor(4096, 1, 1); 
                    
                    source.connect(processor);
                    processor.connect(audioCtx.destination); // ‡∏ï‡πâ‡∏≠‡∏á connect ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏°‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô

                    processor.onaudioprocess = (e) => {
                        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Float32Array: -1.0 ‡∏ñ‡∏∂‡∏á 1.0)
                        const inputData = e.inputBuffer.getChannelData(0); 
                        
                        // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Int16 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÄ‡∏ô‡πá‡∏ï (‡∏à‡∏≤‡∏Å‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡πÄ‡∏¢‡∏≠‡∏∞‡πÜ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°)
                        // ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ
                        const pcmData = new Int16Array(inputData.length);
                        for (let i = 0; i < inputData.length; i++) {
                            // ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡πà‡∏ß‡∏á -1..1 ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô -32768..32767
                            let s = Math.max(-1, Math.min(1, inputData[i]));
                            pcmData[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                        }
                        
                        // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà Server
                        socket.emit("stream_audio", pcmData.buffer);
                    };
                } else {
                    status.innerText += " (‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á)";
                }

            } catch (err) {
                console.error(err);
                status.innerText = "Error: " + err.message;
            }
        });
    </script>
</body>
</html>