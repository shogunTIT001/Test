<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viewer - Video & Audio</title>
    <style>
        body { margin: 0; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; font-family: sans-serif; }
        img { width: 100%; height: 100%; object-fit: contain; }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å) */
        #mute-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 10; cursor: pointer;
        }
        #mute-btn {
            padding: 20px 40px; font-size: 24px; background: #28a745; color: white; border: none; border-radius: 50px;
        }
    </style>
</head>
<body>

    <img id="screen" src="" alt="Waiting...">

    <div id="mute-overlay">
        <button id="mute-btn">üîä ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const img = document.getElementById("screen");
        const muteOverlay = document.getElementById('mute-overlay');
        
        let audioCtx;
        let nextTime = 0; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á

        // ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏° AudioContext ‡πÑ‡∏î‡πâ (‡∏Å‡∏é‡∏Ç‡∏≠‡∏á Browser)
        muteOverlay.addEventListener('click', () => {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            muteOverlay.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°
            console.log("Audio Context Started");
        });

        // 1. ‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏û
        socket.on("stream_data", (data) => {
            img.src = data;
        });

        // 2. ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        socket.on("stream_audio", (arrayBuffer) => {
            if (!audioCtx) return; // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£

            // ‡πÅ‡∏õ‡∏•‡∏á Int16 ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Float32
            const int16 = new Int16Array(arrayBuffer);
            const float32 = new Float32Array(int16.length);
            for (let i = 0; i < int16.length; i++) {
                float32[i] = int16[i] / 32768; // ‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏ß‡∏á -1..1
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Audio Buffer
            const audioBuffer = audioCtx.createBuffer(1, float32.length, audioCtx.sampleRate);
            audioBuffer.getChannelData(0).set(float32);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Source ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô
            const source = audioCtx.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioCtx.destination);

            // ‡∏Å‡∏≤‡∏£ Sync ‡πÄ‡∏ß‡∏•‡∏≤ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å)
            if (nextTime < audioCtx.currentTime) {
                nextTime = audioCtx.currentTime;
            }
            source.start(nextTime);
            
            // ‡∏Ç‡∏¢‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á chunk ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏õ‡∏£‡∏≠‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢
            nextTime += audioBuffer.duration;
        });
    </script>
</body>
</html>